{% extends "base.html" %}

{% block title %}实时监控 - 安全帽检测系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/monitor.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-video-fill text-primary"></i> 实时监控 - {{ monitor_location }}
        </h2>
        <div>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left"></i> 返回首页
            </a>
            <button id="refreshStream" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> 刷新监控
            </button>
        </div>
    </div>

    <!-- 实时监控画面 -->
    <div class="monitor-container">
        <img id="monitorFrame" src="{{ url_for('static', filename='images/loading.gif') }}" alt="实时监控画面">
        <!-- 实时状态统计 -->
        <div class="status-bar">
            <div class="d-flex align-items-center gap-2">
                <span>时间: <span id="currentTime">-</span></span>
                <span>|</span>
                <span>未佩戴: <span id="unauthorizedCount" class="text-danger">0</span></span>
                <span>|</span>
                <span>已佩戴: <span id="authorizedCount" class="text-success">0</span></span>
            </div>
        </div>
    </div>

    <!-- 检测统计卡片 -->
    <div class="stats-grid mb-4">
        <div class="stat-card stat-card-danger">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <h5 class="stat-title">未佩戴安全帽</h5>
                <p class="stat-value text-danger" id="statUnauthorized">0</p>
                <p class="stat-label">当前未佩戴人数</p>
            </div>
        </div>

        <div class="stat-card stat-card-success">
            <div class="stat-icon">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
                <h5 class="stat-title">已佩戴安全帽</h5>
                <p class="stat-value text-success" id="statAuthorized">0</p>
                <p class="stat-label">当前佩戴人数</p>
            </div>
        </div>

        <div class="stat-card stat-card-info">
            <div class="stat-icon">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-content">
                <h5 class="stat-title">检测到的人员</h5>
                <p class="stat-value text-primary" id="statPeople">无</p>
                <p class="stat-label">已识别身份人员</p>
            </div>
        </div>
    </div>

    <!-- 错误/警告提示 -->
    <div id="alertContainer" class="alert d-none" role="alert"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 1. 初始化SSE连接，拉取实时流
    let eventSource;
    function connectSSE() {
        // 关闭现有连接（避免重复连接）
        if (eventSource) {
            eventSource.close();
        }

        // 重置状态
        $('#monitorFrame').attr('src', "{{ url_for('static', filename='images/loading.gif') }}");
        $('#currentTime').text('-');
        $('#unauthorizedCount').text('0').removeClass('alert-badge');
        $('#authorizedCount').text('0');
        $('#statUnauthorized').text('0');
        $('#statAuthorized').text('0');
        $('#statPeople').text('无');
        $('#alertContainer').addClass('d-none');

        // 建立SSE连接
        eventSource = new EventSource("{{ url_for('detection.stream_monitor') }}");

        // 处理SSE消息
        eventSource.onmessage = function(e) {
            const data = JSON.parse(e.data);
            switch(data.type) {
                case 'frame':
                    // 更新实时画面
                    $('#monitorFrame').attr('src', data.frameData);
                    // 更新时间和统计
                    $('#currentTime').text(data.timeStr);
                    $('#unauthorizedCount').text(data.unauthorizedCount);
                    $('#authorizedCount').text(data.authorizedCount);
                    $('#statUnauthorized').text(data.unauthorizedCount);
                    $('#statAuthorized').text(data.authorizedCount);
                    // 未佩戴时闪烁提醒
                    if (data.unauthorizedCount > 0) {
                        $('#unauthorizedCount').addClass('alert-badge');
                    } else {
                        $('#unauthorizedCount').removeClass('alert-badge');
                    }
                    // 更新人员信息
                    const faceNames = data.faces.map(face => face.name).filter(name => name !== '未知人员');
                    $('#statPeople').text(faceNames.length > 0 ? faceNames.join(', ') : '无');
                    break;
                case 'error':
                    // 显示错误提示
                    $('#alertContainer').removeClass('d-none alert-warning').addClass('alert-danger');
                    $('#alertContainer').text(`错误: ${data.message}`);
                    break;
                case 'warning':
                    // 显示警告提示（如流中断）
                    $('#alertContainer').removeClass('d-none alert-danger').addClass('alert-warning');
                    $('#alertContainer').text(`警告: ${data.message}`);
                    break;
                case 'end':
                    // 显示结束提示
                    $('#alertContainer').removeClass('d-none alert-danger').addClass('alert-info');
                    $('#alertContainer').text(data.message);
                    break;
            }
        };

        // SSE连接错误处理
        eventSource.onerror = function() {
            $('#alertContainer').removeClass('d-none alert-warning').addClass('alert-danger');
            $('#alertContainer').text('监控连接异常，正在重试...');
            // 3秒后重试
            setTimeout(connectSSE, 3000);
        };
    }

    // 2. 初始化连接
    connectSSE();

    // 3. 刷新监控按钮事件
    $('#refreshStream').click(function() {
        connectSSE();
        $(this).text('刷新中...').prop('disabled', true);
        setTimeout(() => {
            $(this).text('').append('<i class="bi bi-arrow-repeat"></i> 刷新监控').prop('disabled', false);
        }, 1500);
    });

    // 4. 页面关闭时关闭SSE连接
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
});
</script>
{% endblock %}
