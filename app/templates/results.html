{% extends "base.html" %}

{% block title %}检测结果 - 安全帽检测系统{% endblock %}

{% block extra_css %}
<style>
    .frame-thumbnail {
        height: 180px;
        object-fit: cover;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 4px 4px 0 0;
    }
    .frame-thumbnail:hover {
        transform: scale(1.03);
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    .stat-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 8px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .card {
        border-radius: 8px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        border-radius: 8px 8px 0 0 !important;
    }
    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }
    .table thead {
        background-color: #f8f9fa;
    }
    .no-violation {
        padding: 3rem 0;
        text-align: center;
        color: #28a745;
    }
    .no-violation i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-center">
    <h2>检测结果分析</h2>
    <a href="{{ url_for('main.upload') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> 返回上传
    </a>
</div>

<!-- 统计信息卡片 -->
<div class="row mb-5 g-3">
    <div class="col-md-3">
        <div class="card stat-card bg-light p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="card-title text-muted">视频总时长</h5>
                    <p class="card-text display-5 fw-bold">
                        {% set total_seconds = result['total_frames'] / (result['fps'] if result.get('fps') else 30) %}
                        {{ "%02d"|format(total_seconds // 3600) }}:{{ "%02d"|format((total_seconds % 3600) // 60) }}:{{ "%02d"|format(total_seconds % 60) }}
                    </p>
                </div>
                <div class="bg-primary/10 p-3 rounded-circle">
                    <i class="bi bi-clock text-primary fs-2"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-light p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="card-title text-muted">处理时间</h5>
                    <p class="card-text display-5 fw-bold">{{ "%.2f"|format(result['processing_time']) }} 秒</p>
                </div>
                <div class="bg-info/10 p-3 rounded-circle">
                    <i class="bi bi-hourglass-split text-info fs-2"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-light p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="card-title text-muted">未佩戴安全帽帧数</h5>
                    <p class="card-text display-5 fw-bold">{{ result['unauthorized_frames'] }}</p>
                </div>
                <div class="bg-danger/10 p-3 rounded-circle">
                    <i class="bi bi-exclamation-triangle text-danger fs-2"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-light p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="card-title text-muted">违规人员数</h5>
                    <p class="card-text display-5 fw-bold">
                        {% set unique_people = [] %}
                        {% for r in result['results'] if r['has_unauthorized'] %}
                            {% for face in r['faces'] if face['name'] not in unique_people and face['name'] != '未知人员' %}
                                {% set _ = unique_people.append(face['name']) %}
                            {% endfor %}
                        {% endfor %}
                        {{ unique_people|length }} 人
                    </p>
                </div>
                <div class="bg-warning/10 p-3 rounded-circle">
                    <i class="bi bi-people text-warning fs-2"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 违规帧展示 -->
<div class="card mb-5">
    <div class="card-header">
        <h5 class="mb-0">未佩戴安全帽的违规帧 <span class="badge bg-danger">{{ result['unauthorized_frames'] }}</span></h5>
    </div>
    <div class="card-body">
        <div class="row" id="framesContainer">
            {% if result['unauthorized_frames'] > 0 %}
                {% for r in result['results'] if r['has_unauthorized'] %}
                    {% set frame_filename = 'unauthorized_' + r['time_str'].replace(':', '-') + '_frame_' + r['frame_count']|string + '.jpg' %}
                    {% set frame_path = frames_dir + '/' + frame_filename %}
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card h-100 overflow-hidden">
                            <img src="{{ frame_path }}" class="card-img-top frame-thumbnail"
                                 alt="未佩戴安全帽 - {{ r['time_str'] }}"
                                 onerror="this.src='{{ url_for('static', filename='images/error.png') }}'">
                            <div class="card-body">
                                <h6 class="card-title mb-2">
                                    <i class="bi bi-clock text-muted"></i> {{ r['time_str'] }}
                                </h6>
                                <p class="card-text small">
                                    <span class="badge bg-danger">未佩戴人数: {{ r['unauthorized_count'] }}</span>
                                </p>
                                <p class="card-text small mt-2">
                                    <strong>涉及人员:</strong>
                                    {% set face_names = [] %}
                                    {% for face in r['faces'] %}
                                        {% set _ = face_names.append(face['name']) %}
                                    {% endfor %}
                                    {{ ', '.join(face_names) if face_names else '未知' }}
                                </p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-violation col-12">
                    <i class="bi bi-check-circle"></i>
                    <h3>未检测到未佩戴安全帽的情况</h3>
                    <p class="text-muted">所有人员均规范佩戴安全帽</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 详细数据表格 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">详细检测记录</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>时间点</th>
                        <th>总检测人数</th>
                        <th>未佩戴安全帽</th>
                        <th>佩戴安全帽</th>
                        <th>未佩戴人员信息</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in result['results'] %}
                    <tr {% if r['has_unauthorized'] %}class="table-danger"{% endif %}>
                        <td>{{ r['time_str'] }}</td>
                        <td>{{ r['total_detections'] }}</td>
                        <td>
                            {% if r['unauthorized_count'] > 0 %}
                                <span class="badge bg-danger">{{ r['unauthorized_count'] }}</span>
                            {% else %}
                                {{ r['unauthorized_count'] }}
                            {% endif %}
                        </td>
                        <td>
                            {% if r['authorized_count'] > 0 %}
                                <span class="badge bg-success">{{ r['authorized_count'] }}</span>
                            {% else %}
                                {{ r['authorized_count'] }}
                            {% endif %}
                        </td>
                        <td>
                            {% if r['has_unauthorized'] %}
                                {% set person_list = [] %}
                                {% for face in r['faces'] %}
                                    {% set person_info = face['name'] + '(' + face['code'] + ')' %}
                                    {% set _ = person_list.append(person_info) %}
                                {% endfor %}
                                {{ ', '.join(person_list) if person_list else '未知人员' }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 帧图片点击放大功能
    $('.frame-thumbnail').click(function() {
        const imgSrc = $(this).attr('src');
        const modal = $('<div class="modal fade" tabindex="-1" aria-hidden="true">')
            .append($('<div class="modal-dialog modal-xl">')
                .append($('<div class="modal-content">')
                    .append($('<div class="modal-header">')
                        .append($('<h5 class="modal-title">违规帧详情</h5>'))
                        .append($('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>'))
                    )
                    .append($('<div class="modal-body p-0">')
                        .append($('<img src="' + imgSrc + '" class="w-100">'))
                    )
                    .append($('<div class="modal-footer">')
                        .append($('<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>'))
                    )
                )
            );

        $('body').append(modal);
        modal.modal('show');

        // 关闭时移除模态框
        modal.on('hidden.bs.modal', function() {
            modal.remove();
        });
    });

    // 表格滚动时表头固定
    const tableContainer = $('.table-responsive');
    tableContainer.scroll(function() {
        const scrollTop = $(this).scrollTop();
        if (scrollTop > 10) {
            $(this).find('thead').addClass('shadow-sm');
        } else {
            $(this).find('thead').removeClass('shadow-sm');
        }
    });
});
</script>
{% endblock %}